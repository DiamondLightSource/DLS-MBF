# Tune fitting IOC

from pkg_resources import require
import sys, os

require('cothread==2.14')
require('numpy>=1.11.1')
require('epicsdbbuilder==1.2')

# Import the basic framework components.
from softioc import softioc, builder
from softioc import pvlog

import cothread
import fit_loop
import persistence
import support


# Start by loading the configuration file
config = support.read_config(sys.argv[1])

# Read the required configuration parameters
ioc_name = config['ioc_name']
sources = config['sources'].split()


# A couple of identification PVs
builder.SetDeviceName(ioc_name)
builder.stringIn('WHOAMI', VAL = 'Beam Current Lifetime Monitor')
builder.stringIn('HOSTNAME', VAL = os.uname()[1])
builder.UnsetDevice()


# Create the fitters
persist = persistence.Persistence(config)
fitters = [fit_loop.TuneFitLoop(persist, config, source) for source in sources]

# Now get the IOC started
builder.LoadDatabase()
softioc.iocInit()

# Finally run the fitters
persist.start()
for fitter in fitters:
    fitter.start()

#softioc.interactive_ioc(globals())
cothread.WaitForQuit()

# vim: set filetype=python:
