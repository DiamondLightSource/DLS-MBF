\documentclass[
    a4paper,
    keeplastbox,            % Prevents problems with last line in references
    hyphens,                % Allow hyphenation in \url
    nospread,               % Suppress whitespace fill for column balancing
%     boxit,                  % Show margins (debug only)
]{jacow}

\usepackage{amsmath}        % General mathematical symbols
% Reminder of amsmath environments:
%   equation    single equation
%   gather      multiple equations
%   align       aligned equations
%   multiline   equations split over multiple lines

\usepackage{tikz}           % Powerful drawing package, part of pgf

% \usepackage[euler]{textgreek}      % text greek letters

% The following packages seem to be part of or redundant when using jacow:
% \usepackage{mathptmx}       % Mathematical PostScript fonts
% \usepackage{textcomp}       % Text companion fonts (part of jacow?)
% \usepackage{graphicx}       % Extended support for \includegraphics
% \usepackage{enumitem}       % For more control over list parameters.
%

% Consider using Itemize, Enumerate, Description


\input{THPHA115f0.tikz}     % Common PGF & TikZ configuration

\newcommand\smallbox[2][small box]{\tikz [inline text] \node [#1] {#2};}




\hyphenpenalty 2000         % Tone down hyphenation


\begin{document}
\title{A New Transverse and Longitudinal Bunch by Bunch Feedback Processor}
\author{
    M.G.~Abbott, G.~Rehm, Diamond Light Source, UK\\
    I.S.~Uzun, STFC, UK}
\maketitle

\begin{abstract}

We describe the development of firmware to support Longitudinal Bunch by Bunch
Feedback at Diamond Light source.  As well as feedback, the system supports
complex experiments and the capture of detailed diagnostics.  In this paper we
describe the firmware development and some details of the processing chain.  We
focus on some of the challenges of FPGA development from the perspective of a
software engineer.  Another interesting challenge was posed by the decision to
develop the entire signal processing chain to run at 500\,MHz.  This does work
well enough, but presents numerous challenges; it would probably have been
simpler to run at half the clock speed!

\end{abstract}


\section{Introduction}

At Diamond Light Source (DLS) we have been working on multi-bunch feedback for
more than a decade~\cite{dipac2007, epac2008, biw2010, icalepcs2011, ibic2013,
ibic2014, icalepcs2015}, this work being originally based on developments at the
ESRF~\cite{epac2006}.  Up to now our work has been based on the Libera platform
\cite{libera}, which is now obsolete and has limited capacity for further
developments --- at the time of writing the Virtex-II Pro FPGA at the heart of
the Libera processor is 15 years old.  Up to now we have focused on stabilising
and measuring only transverse instabilities.

More recently we have been asked to provide support for measurement and
stabilisation of longitudinal multi-bunch instabilities as part of an ongoing
project to install normally conducting RF cavities~\cite{ipac2017rf}.  It is
anticipated that these may introduce extra resonances and instabilities which
will need special treatment.

We have therefore been working on a project to upgrade our TMBF (Transverse
Multi-Bunch Feedback) system to run on more modern hardware and to add
longitudinal capabilities to the system, so creating an LMBF (Longitudinal
Multi-Bunch Feedback) processor.  We have already reported~\cite{ibic2016} on
our preliminary work on the new system and on the choice of hardware; we'll
discuss this further below.

In this paper we will describe the architecture of the new LMBF (Longitudinal
Multi-Bunch Feedback) processor based on our chosen hardware, and discuss some
of the lessons learned during this development.  From a software engineering
perspective, development of a complex FPGA system presents some remarkable
challenges, which we'll also discuss.


\section{Hardware Platform}

\begin{figure}
\includegraphics[width=\linewidth]{fmc500.png}
\caption{Photo of assembly of FMC-500 and Digital IO FMC on the AMC525 carrier,
with FMC-500 at top right.}
\label{fmc500}
\end{figure}


\begin{figure*} %[!t]
\begin{centering}
\input{overview.tikz}
\end{centering}
\caption{Overview of LMBF signal processing chain.
    Key: \smallbox{OVF}~ADC input overflow detection;
    \smallbox{FIR}~I/O compensation filter;
    \smallbox{MMS}~bunch position and motion measurement;
    \smallbox{$\div$N}~bunch by bunch decimation;
    \smallbox{BB FIR}~bunch by bunch filter;
    \smallbox{$\times$N}~bunch by bunch interpolation;
    \smallbox{G}~gain control;
    \smallbox{DLY}~output alignment delay;
    \smallbox[mul, inner sep=2pt]{$\sim$}~controllable oscillator (NCO).
}
\label{overview}
\end{figure*}



As noted above, the development of our new LMBF processor was driven by two
motivations: to ensure that we are ready for any new longitudinal instabilities,
and to increase the capabilities of our existing system~\cite{ipac2017rf,
ibic2016}.  We also wanted to improve our knowledge and understanding of high
speed processing hardware relevant to synchrotron diagnostics.

We started with an investigation to determine the appropriate hardware platform
for this kind of development.  Early on it was decided that we would need a
powerful FPGA with FMC (FPGA Mezzanine Card) support.  Initially we looked at
self contained FPGA platforms, and even briefly considered creating our own, but
in the end we converged on MicroTCA~\cite{mtca}.  This platform provides us with
a wide choice of crates and AMC (ATCA Mezzanine Card) processing modules with
high speed interconnect, and turns out to be compatible with a concurrent
development at DLS to develop Low Level RF with ALBA~\cite{ipac2017llrf}.

Having selected MicroTCA as our platform we then selected the following
hardware.  Figure \ref{fmc500} shows the digital processing hardware assembled
ready for insertion in the MicroTCA crate.

\begin{Description}
\item[FMC-500M]
    (HPC) High Pin Count FMC providing dual channel 500\,MS/s 14-bit ADC and
    dual channel 1230\,MS/s 16-bit DAC~\cite{fmc500}.  This will support
    bunch-by-bunch operation at our machine RF frequency of 500\,MHz, and can be
    driven by our machine clock.
\item[FmcDIO5chTTLa]
    Five port digital IO FMC~\cite{fmcdio}.  This is used for miscellaneous
    triggering and other signals.
\item[AMC525]
    Double width AMC card with two HPC FMC slots, 2\,GB of fast on board DRAM
    and 128\,MB of slower DRAM connected to a Virtex-7 690 FPGA, supporting an 8
    lane gen3 PCIe connection over the MicroTCA backplane~\cite{amc525}.  This
    is our workhorse where all the FPGA firmware will run, and the fast
    backplane connection will allow us to do a lot of data processing in the
    associated CPU.
\item[AMC720]
    This is an AMC card with an Intel Xeon processor with ample memory and
    sufficient local storage.  We install Red Hat Enterprise Linux 7 on this,
    and run our control system and any associated signal processing.
\item[VT814]
    This is a 2U MicroTCA chassis with 6 AMC slots and dual redundant power
    supplies.
\end{Description}



\section{Functionality and Design}

\subsection{Functionality}

The bunch-by-bunch processor has two functions: to stabilise coupled bunch
oscillations of the electron beam, and to provide diagnostics functions for
measuring beam behaviour and detailed parameters.

Bunch oscillation is stabilised by a feedback filter applied to each bunch to
generate feedback at around 180\textdegree{} out of phase.

For diagnostics our processor provides the following functionality:
\begin{Itemize}
\item
    Capture of up to 2\,GB of two channels of 500\,MS/s data, selectable from
    different processing stages.  This allows the capture of bunch by bunch
    behaviour and feedback channels.
\item
    Numerically Controlled Oscillators (NCOs) for driving excitation
    onto the beam.  This is used for tune measurement and grow damp experiments.
\item
    Detectors for capturing IQ data by mixing an NCO with the beam response.
    Outputs from the detectors are written to slow memory.
\item
    Sequencer for programming a sequence of NCO frequencies and programming the
    behaviour of the detectors.
\item
    Individual bunch controls.  For each bunch a different excitation and
    different feedback filter can be selected.
\end{Itemize}

Diagnostics experiments are performed by programming the bunch controls, the
available filters and the sequencer, and then the sequencer is triggered.
Measurements are then written to slow memory.


\subsection{System Design}

Figure \ref{overview} shows the signal processing chain as implemented in the
current design.  This is not so very different from figure 3 of our
ICALEPCS~2015 paper~\cite{icalepcs2015}.  The main enhancements are the improved
bunch by bunch motion measurement, longer FIR filters throughout, and rate
change to support longitudinal processing.


\subsection{Longitudinal vs Transverse Processing}

There is not too much difference in the processing required for longitudinal vs
transferse bunch by bunch feedback --- the biggest differences is in the output
drive chain after the DAC, as described in~\cite{ibic2016}.  However, there are
a few differences that are important to our system.

\begin{Itemize}
\item
    Operation is on beam phase.  We operate on a phase adjusted intensity signal
    as a proxy for phase.  We will take two channels $I,Q$ of input at
    90\textdegree{} phase separation, but the overall phase will be controlled
    to drive one channel, $Q$, as close to zero as possible.
\item
    Output will be used to drive a mixer, and for efficiency we will want to use
    an IQ mixer driven with signals separated by 90\textdegree{}.
\item
    The synchrotron tune (longitudinal oscillation frequency) is a low fraction
    of the machine revolution frequency, in our case typically around 0.004.
    This will require a substantial frequency shift (by down and up sampling).
\end{Itemize}

Despite these differences, we are able to write the same software and firmware
to implement both longitudinal and transferse multi-bunch processing.



\section{Implementation}


\subsection{Interconnect}

\begin{figure}
\begin{centering}
\input{interconnect.tikz}
\end{centering}
\caption{Interconnect between PCI Express core (PCIe), memory (DRAM), and the
LMBF processor (DSP).}
\label{interconnect}
\end{figure}

After the ``Hello World'' step of getting flashing LEDs, the very first
development was of what I have called the ``Interconnect''.  This part of the
system glues together all of the core resources provided by the FPGA carrier
card to provide a basic environment for the development of the rest of the
system.

Figure \ref{interconnect} illustrates the basic structure of the interconnect.
The register interface is used by the control system to manage the rest of the
processing chain (referred to as DSP here), a simple interrupt controller, and a
DMA engine for transferring data from DRAM to processor memory.

This part of the FPGA design was constructed using the Vivado Block Design
editor, which is a graphical tool for configuring and linking Xilinx components
into a complete design.  The AXI bus is used to connect all of the components.


\subsection{Kernel Driver}

A dedicated kernel driver manages the interface to this part of the core system.
The DSP registers are available to be mapped into memory, whereas the DMA and
interrupt control registers are managed by the driver only.  This allows for
separation between the constantly evolving system interface, running in user
space, and the fixed interrupt and memory management.  Also, it is helpful to
separate out the memory and interrupt management, as this part of the system is
able to crash or otherwise compromise the behaviour of the control processor.

The kernel driver presents three device nodes to userspace, one for mapping
registers into memory and receiving interrupt events, and two for memory readout
(the AMC525 provides two banks of DRAM).  The design and implementation of this
driver has remained unchanged since the start of the project.


\subsection{Top Level System Design}

The FPGA design is structured into the interconnect described above
(Fig.~\ref{interconnect}), interfaces to the two FMC cards, two channels of
feedback processing (DSP), and a shared register control interface.  Four banks
of registers provide control over:
\begin{Itemize}
\item
    System level registers for clock management and FMC-500 control and setup.
\item
    Control registers for resources shared between the two DSP channels
    including triggering and fast capture to memory.
\item
    Two banks of registers, one dedicated to each DSP channel.
\end{Itemize}

A custom software tool is used to manage the list of register assignments.  From
a central list of registers and fields, VHDL definitions, C \texttt{struct}
definitions, and documentation are automatically generated.  This makes it
straighforward to add remove or rearrange registers, which is otherwise
labourious and error prone.


\subsection{FMC-500 Configuration}

The FMC-500 is built from three key devices, a PLL clock controller (LMK04828),
a dual channel ADC (AD9684), and a dual channel DAC (AD9122), each of which is
controlled by a dedicated SPI interface.  The ADC and DAC are relatively
straighforward to configure (the DAC is somewhat more complex), but the PLL
controller is very complex.  A Python script captures the complex register
interface to the LMK04828.


An initial challenge to getting the FMC-500 up and running was that the
documentation for the card~\cite{fmc500} is rather thin and lacking in important
detail; I understand that the normal application for this component is as part
of a vendor supplied system.  However, the manufacturer was very helpful in
answering my questions and providing the missing pieces.


\subsection{Signal Processing Chain}

Most of the LMBF signal processing chain was taken from our last TMBF
design~\cite{icalepcs2015}, but a lot of the work ended up being a rewrite
rather than simply coping the original code.  The most important changes to the
original design include the following:
\begin{Itemize}
\item
    Beam motion measurement now also measures mean beam position and standard
    deviation of motion.
\item
    Bunch by bunch down and up sampling is now part of the bunch-by-bunch FIR.
    This is needed for LMBF support to support the very low synchrotron tune
    number.
\item
    There are now multiple detectors with individual bunch enables on each
    detector.
\item
    Cross-bars are provided at key points in the signal processing chain to
    support IQ processing for LMBF feedback and excitation.
\end{Itemize}


\subsection{EPICS Driver}

\subsection{Running at 500\,MHz}


\section{Development Challenges}

\begin{itemize}
\item
    Primitive language support
\item
    Proprietary vendor lock-in at every level of development
\item
    Restrictive licensing
\item
    Working for source control
\item
    Poor placement at high clock speeds
\end{itemize}

\subsection{Block Design Tool}

This is a frustrating tool to use.  At first it looks very nice and slick, and
it is very easy to configure and join Xilinx defined components together.
However, it is brittle and easy to confuse, and internally seems to be held
together by string sealing wax and tcl.

Source control of Vivado projects requires a lot of discipline as the tool seems
designed to be almost hostile to source only control.  There is functional
scripting support in Vivado, but it is fiddly labourious and tricky to set up,
and is fragile against changes of tool version.


\begin{thebibliography}{99}

\bibitem{icalepcs2015}
M.G.~Abbott, G.~Rehm, I.S.~Uzun,
\emph{Architecture of Transverse Multi-Bunch Feedback Processor at Diamond},
ICALEPCS 2015

\bibitem{dipac2007}
A.F.D.~Morgan, G.~Rehm, I.~Uzun, \emph{First Tests of the Transverse Multibunch
Feedback at Diamond}, DIPAC~2007.

\bibitem{epac2008}
A.F.D.~Morgan, G.~Rehm, I.~Uzun, \emph{Performance and Features of the Diamond
TMBF System}, EPAC~2008.

\bibitem{biw2010}
G.~Rehm, M.G.~Abbott, A.F.D.~Morgan, J.~Rowland, I.~Uzun, \emph{Measurement of
Lattice Parameters Without Visible Disturbance to User Beam at Diamond Light
Source}, BIW~2010.

\bibitem{icalepcs2011}
I.~Uzun, M.G.~Abbott, M.T.~Heron, A.F.D.~Morgan, G.~Rehm, \emph{Operational
Status of the Transverse Multibunch Feedback System at Diamond}, ICALEPCS~2011.

\bibitem{ibic2013}
M.G.~Abbott, G.~Rehm, I.S.~Uzun, \emph{Capability Upgrade of the Diamond
Transverse Multibunch Feedback}, IBIC~2013.

\bibitem{ibic2014}
G.~Rehm, M.G.~Abbott, A.F.D~Morgan, \emph{New Features and Measurements using
the Upgraded Transverse Multibunch Feedback at Diamond}, IBIC~2014.

\bibitem{epac2006}
E.~Plouviez, P.~Arnoux, F.~Epaud, J.~Jacob, J.M.~Koch, N.~Michel, G.A.~Naylor,
J.\mbox{-}L.~Revol, V.~Serriere, D.~Vial, \emph{Broadband Bunch by Bunch
Feedback for the ESRF using a Single High Resolution and Fast Sampling FPGA
DSP}, EPAC~2006.

\bibitem{libera}
Instrumentation Technologies, \emph{Libera Bunch-by-Bunch},
\url{http://www.i-tech.si}.

\bibitem{ipac2017rf}
C.~Christou et al., \emph{Progress with the Diamond Light Source RF Upgrade},
IPAC~2017

\bibitem{ibic2016}
G.~Rehm, M.G.~Abbott, A.F.D.~Morgan, \emph{Measurements of Longitudinal Coupled
Bunch Instabilities and Status of New Feedback System}, IBIC~2016.

\bibitem{mtca}
MicroTCA Overview, PICMG, \url{https://www.picmg.org/openstandards/microtca/}

\bibitem{fmc500}
Innovative Integration, \emph{FMC-500, FMC Module with 2x 500 MSPS 14-bit A/D,
2x 1230 MSPS 16-bit DACs with PLL and Timing Controls},
\url{https://www.innovative-dsp.com/products.php?product=FMC-500}

\bibitem{fmcdio}
CERN Open Hardware Repository, \emph{FMC DIO 5ch TTL a},
\url{https://www.ohwr.org/projects/fmc-dio-5chttla}

\bibitem{amc525}
Vadatech, \emph{AMC525, dual FMC carrier, 2 FMC, 690T FPGA, FFG-1761 package,
FPGA Mezzanine Card}, \url{http://vadatech.com/product.php?product=393}.

\bibitem{ipac2017llrf}
P.~Gu et al., \emph{Digital Low Level RF Systems for Diamond Light Source},
IPAC~2017


\end{thebibliography}


\end{document}
