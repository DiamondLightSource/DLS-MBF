#!/bin/bash

HERE="$(dirname "$0")"

IOC="$HERE"/bin/linux-x86_64/lmbf

HW_CONFIG=("$HERE"/hardware_delays)
DEBUG=()

while getopts 'vltzh' option; do
    case "$option" in
        v)  DEBUG=(valgrind) ;;
        l)  DEBUG=("$DEBUG[@]" --leak-check=full) ;;
        t)  DEBUG=("$DEBUG[@]" --track-origins=yes) ;;
        z)  HW_CONFIG=() ;;
        h)  cat <<EOF
Usage: runioc [options]
Starts LMBF IOC with configured options.
    -v      Run with valgrind memory checker enabled
    -l      Add leak check to valgrind
    -z      Disable delay compensation
EOF
            exit 0;;
        *)  echo >&2 'Invalid option: try -h for help'
            exit 1 ;;
    esac
done
shift $((OPTIND-1))

SYS_CONFIG="${1:?Must specify system configuration}"
shift

DEV_ADDR=pci-0000:04:00.0


# Initialise the hardware.  This sets up the clock PLL, ADC and DAC.  The rest
# of the system will be initialised by the IOC proper.
"$HERE"/setup_lmbf "$SYS_CONFIG"  &&

exec "${DEBUG[@]}" "$IOC" -C "$HERE" "$SYS_CONFIG" "${HW_CONFIG[@]}"
