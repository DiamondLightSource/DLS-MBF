#!/bin/sh

cd "$(dirname "$(readlink -f "$0")")"/opi
PATH="scripts/:$PATH"

DEVICE="$1"
if [[ -z $DEVICE ]]; then
    MACROS=()
    START=lmbf_launcher.edl
else
    AXIS0="$(caget -t "$DEVICE:AXIS0")"  &&
    AXIS1="$(caget -t "$DEVICE:AXIS1")"  &&
    MODE="$(caget -t "$DEVICE:MODE")"  ||
        exit 1

    case "$MODE" in
        TMBF)   START=lmbf/tmbf.edl ;;
        LMBF)   START=lmbf/lmbf.edl ;;
        *)      echo >&2 "Unknown MODE: $MODE"
                exit 2 ;;
    esac

    MACROS=(
        -m device="$DEVICE"
        -m mode="$MODE"
        -m chan0="$AXIS0"
        -m chan1="$AXIS1")
    if [[ "$MODE" = LMBF ]]; then
        MACROS=("${MACROS[@]}" -m chan01="$AXIS0$AXIS1")
    fi
fi

edm -x -eolc "${MACROS[@]}" "$START" &
